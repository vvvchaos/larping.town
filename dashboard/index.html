<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Larping.town Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #36393f;
            color: #dcddde;
            font-family: Arial, sans-serif;
        }
        .container {
            max-width: 900px;
            margin-top: 50px;
        }
        .card {
            background-color: #2f3136;
            border: none;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        .btn-discord {
            background-color: #5865F2;
            color: white;
        }
        .btn-discord:hover {
            background-color: #4752c4;
            color: white;
        }
        .nav-tabs .nav-link {
            color: #dcddde;
        }
        .nav-tabs .nav-link.active {
            background-color: #2f3136;
            color: white;
            border-color: #444 #444 #2f3136;
        }
        .list-group-item {
            background-color: #36393f;
            color: #dcddde;
            border-color: #444;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card mb-4">
            <div class="card-body text-center p-5" id="login-card">
                <h1 class="mb-4">Larping.town</h1>
                <p class="mb-4">Login with Discord to access your dashboard</p>
                <a href="#" id="login-button" class="btn btn-discord btn-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-discord me-2" viewBox="0 0 16 16">
                        <path d="M13.545 2.907a13.227 13.227 0 0 0-3.257-1.011.05.05 0 0 0-.052.025c-.141.25-.297.577-.406.833a12.19 12.19 0 0 0-3.658 0 8.258 8.258 0 0 0-.412-.833.051.051 0 0 0-.052-.025c-1.125.194-2.22.534-3.257 1.011a.041.041 0 0 0-.021.018C.356 6.024-.213 9.047.066 12.032c.001.014.01.028.021.037a13.276 13.276 0 0 0 3.995 2.02.05.05 0 0 0 .056-.019c.308-.42.582-.863.818-1.329a.05.05 0 0 0-.01-.059.051.051 0 0 0-.018-.011 8.875 8.875 0 0 1-1.248-.595.05.05 0 0 1-.02-.066.051.051 0 0 1 .015-.019c.084-.063.168-.129.248-.195a.05.05 0 0 1 .051-.007c2.619 1.196 5.454 1.196 8.041 0a.052.052 0 0 1 .053.007c.08.066.164.132.248.195a.051.051 0 0 1-.004.085 8.254 8.254 0 0 1-1.249.594.05.05 0 0 0-.03.03.052.052 0 0 0 .003.041c.24.465.515.909.817 1.329a.05.05 0 0 0 .056.019 13.235 13.235 0 0 0 4.001-2.02.049.049 0 0 0 .021-.037c.334-3.451-.559-6.449-2.366-9.106a.034.034 0 0 0-.02-.019Zm-8.198 7.307c-.789 0-1.438-.724-1.438-1.612 0-.889.637-1.613 1.438-1.613.807 0 1.45.73 1.438 1.613 0 .888-.637 1.612-1.438 1.612Zm5.316 0c-.788 0-1.438-.724-1.438-1.612 0-.889.637-1.613 1.438-1.613.807 0 1.451.73 1.438 1.613 0 .888-.631 1.612-1.438 1.612Z"/>
                    </svg>
                    Login with Discord
                </a>
            </div>
        </div>

        <div id="dashboard" class="hidden">
            <div class="card mb-4">
                <div class="card-body">
                    <div class="d-flex align-items-center mb-4">
                        <img id="user-avatar" src="" alt="User Avatar" class="rounded-circle me-3" width="64" height="64">
                        <div>
                            <h2 id="username" class="mb-0"></h2>
                            <small id="user-id" class="text-muted"></small>
                        </div>
                        <button id="logout-button" class="btn btn-outline-danger ms-auto">Logout</button>
                    </div>

                    <ul class="nav nav-tabs" id="dashboardTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="profile-tab" data-bs-toggle="tab" data-bs-target="#profile" type="button" role="tab" aria-controls="profile" aria-selected="true">Profile</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="groups-tab" data-bs-toggle="tab" data-bs-target="#groups" type="button" role="tab" aria-controls="groups" aria-selected="false">Groups</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="invites-tab" data-bs-toggle="tab" data-bs-target="#invites" type="button" role="tab" aria-controls="invites" aria-selected="false">Invites</button>
                        </li>
                    </ul>

                    <div class="tab-content p-3" id="dashboardTabsContent">
                        <div class="tab-pane fade show active" id="profile" role="tabpanel" aria-labelledby="profile-tab">
                            <div class="card mb-3">
                                <div class="card-body">
                                    <h5 class="card-title">Your Faction</h5>
                                    <p id="user-group">You are not currently in any faction.</p>
                                </div>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="groups" role="tabpanel" aria-labelledby="groups-tab">
                            <div class="row mb-3">
                                <div class="col">
                                    <h5>Your Groups</h5>
                                </div>
                                <div class="col-auto">
                                    <button class="btn btn-sm btn-primary" id="create-group-btn">Create New Group</button>
                                </div>
                            </div>
                            
                            <div id="create-group-form" class="card mb-3 hidden">
                                <div class="card-body">
                                    <h5 class="card-title">Create New Group</h5>
                                    <form id="group-form">
                                        <div class="mb-3">
                                            <label for="group-name" class="form-label">Group Name</label>
                                            <input type="text" class="form-control" id="group-name" required>
                                        </div>
                                        <button type="submit" class="btn btn-success">Create</button>
                                        <button type="button" class="btn btn-secondary" id="cancel-create-group">Cancel</button>
                                    </form>
                                </div>
                            </div>
                            
                            <div id="owned-groups">
                                <h6 class="mb-3">Groups You Own</h6>
                                <div id="owned-groups-list" class="list-group mb-4">
                                    <!-- Owned groups will be populated here -->
                                </div>
                            </div>
                            
                            <div id="member-groups">
                                <h6 class="mb-3">Groups You're In</h6>
                                <div id="member-groups-list" class="list-group">
                                    <!-- Member groups will be populated here -->
                                </div>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="invites" role="tabpanel" aria-labelledby="invites-tab">
                            <h5 class="mb-3">Your Invites</h5>
                            <div id="invites-list" class="list-group">
                                <!-- Invites will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Discord OAuth2 Configuration
        const CLIENT_ID = '1369805733972938923';
        const REDIRECT_URI = 'https://larping.town/dashboard';
        const API_BASE_URL = 'https://larping.town'; // Updated to the production URL
        
        // GitHub repository URLs
        const USERS_JSON_URL = 'https://raw.githubusercontent.com/vvvchaos/larping.town/refs/heads/main/users.json';
        const GROUPS_JSON_URL = 'https://raw.githubusercontent.com/vvvchaos/larping.town/refs/heads/main/groups.json';
        
        // DOM Elements
        const loginCard = document.getElementById('login-card');
        const dashboard = document.getElementById('dashboard');
        const loginButton = document.getElementById('login-button');
        const logoutButton = document.getElementById('logout-button');
        const userAvatar = document.getElementById('user-avatar');
        const username = document.getElementById('username');
        const userId = document.getElementById('user-id');
        const userGroup = document.getElementById('user-group');
        const createGroupBtn = document.getElementById('create-group-btn');
        const createGroupForm = document.getElementById('create-group-form');
        const groupForm = document.getElementById('group-form');
        const cancelCreateGroup = document.getElementById('cancel-create-group');
        const ownedGroupsList = document.getElementById('owned-groups-list');
        const memberGroupsList = document.getElementById('member-groups-list');
        const invitesList = document.getElementById('invites-list');
        
        // Initialize Dashboard
        document.addEventListener('DOMContentLoaded', () => {
            // Set up login button URL
            const scope = 'identify';
            loginButton.href = `https://discord.com/api/oauth2/authorize?client_id=${CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&response_type=code&scope=${scope}`;
            
            // Check for OAuth code in URL
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            
            if (code) {
                // Remove code from URL without refreshing page
                window.history.replaceState({}, document.title, REDIRECT_URI);
                
                // Exchange code for access token
                exchangeCodeForToken(code);
            } else {
                // Check for stored user data
                const storedUser = localStorage.getItem('discord_user');
                if (storedUser) {
                    handleLogin(JSON.parse(storedUser));
                }
            }

            // Set up event listeners
            logoutButton.addEventListener('click', handleLogout);
            createGroupBtn.addEventListener('click', () => {
                createGroupForm.classList.remove('hidden');
            });
            
            cancelCreateGroup.addEventListener('click', () => {
                createGroupForm.classList.add('hidden');
                groupForm.reset();
            });
            
            groupForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const groupName = document.getElementById('group-name').value;
                createGroup(groupName);
                createGroupForm.classList.add('hidden');
                groupForm.reset();
            });
        });

        // Exchange code for token and get user data
        async function exchangeCodeForToken(code) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/auth/token`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ code })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to exchange code for token');
                }
                
                const data = await response.json();
                
                // Store token if needed
                localStorage.setItem('discord_token', JSON.stringify(data.token));
                
                // Handle login with user data
                handleLogin(data.user);
            } catch (error) {
                console.error('Error exchanging code for token:', error);
                // For demo purposes, fallback to mock data if the API call fails
                const mockUserData = {
                    id: '123456789012345678',
                    username: 'DemoUser',
                    discriminator: '1234',
                    avatar: 'https://cdn.discordapp.com/embed/avatars/0.png'
                };
                handleLogin(mockUserData);
            }
        }

        // Handle successful login
        function handleLogin(userData) {
            // Save user data to localStorage for persistence
            localStorage.setItem('discord_user', JSON.stringify(userData));
            
            // Update UI
            loginCard.classList.add('hidden');
            dashboard.classList.remove('hidden');
            
            // Set user data
            userAvatar.src = userData.avatar;
            username.textContent = `${userData.username}#${userData.discriminator}`;
            userId.textContent = `ID: ${userData.id}`;
            
            // Fetch user's group info
            fetchUserGroup(userData.id);
            
            // Fetch groups and invites
            fetchGroups(userData.id);
            fetchInvites(userData.id);
        }

        // Handle logout
        function handleLogout() {
            localStorage.removeItem('discord_user');
            loginCard.classList.remove('hidden');
            dashboard.classList.add('hidden');
        }

        // Fetch user's group info
        async function fetchUserGroup(userId) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/users/${userId}`);
                
                if (!response.ok) {
                    throw new Error('Failed to fetch user group');
                }
                
                const userData = await response.json();
                
                if (userData.group) {
                    userGroup.textContent = `You are a member of "${userData.group}".`;
                }
            } catch (error) {
                console.error('Error fetching user group:', error);
                // For demo purposes, fallback to mock data if the API call fails
                const mockUserData = {
                    userId: userId,
                    group: 'Emerald Knights'
                };
                if (mockUserData.group) {
                    userGroup.textContent = `You are a member of "${mockUserData.group}".`;
                }
            }
        }

        // Fetch groups
        async function fetchGroups(userId) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/groups?userId=${userId}`);
                
                if (!response.ok) {
                    throw new Error('Failed to fetch groups');
                }
                
                const groups = await response.json();
                renderGroups(groups);
            } catch (error) {
                console.error('Error fetching groups:', error);
                // For demo purposes, fallback to mock data if the API call fails
                const mockGroups = {
                    owned: [
                        { id: 'g1', name: 'Dragon Slayers', members: 12 }
                    ],
                    member: [
                        { id: 'g2', name: 'Mystic Order', members: 8 }
                    ]
                };
                
                renderGroups(mockGroups);
            }
        }

        // Render groups
        function renderGroups(groups) {
            // Render owned groups
            ownedGroupsList.innerHTML = '';
            if (groups.owned.length === 0) {
                ownedGroupsList.innerHTML = '<div class="list-group-item">You don\'t own any groups yet.</div>';
            } else {
                groups.owned.forEach(group => {
                    const item = document.createElement('div');
                    item.className = 'list-group-item d-flex justify-content-between align-items-center';
                    item.innerHTML = `
                        <div>
                            <h6>${group.name}</h6>
                            <small>${group.members} members</small>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-outline-primary invite-btn" data-group-id="${group.id}">Invite User</button>
                            <button class="btn btn-sm btn-outline-danger delete-group-btn" data-group-id="${group.id}">Delete</button>
                        </div>
                    `;
                    ownedGroupsList.appendChild(item);
                });

                // Add event listeners to the invite buttons
                document.querySelectorAll('.invite-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const groupId = e.target.getAttribute('data-group-id');
                        promptInvite(groupId);
                    });
                });

                // Add event listeners to the delete buttons
                document.querySelectorAll('.delete-group-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const groupId = e.target.getAttribute('data-group-id');
                        deleteGroup(groupId);
                    });
                });
            }

            // Render member groups
            memberGroupsList.innerHTML = '';
            if (groups.member.length === 0) {
                memberGroupsList.innerHTML = '<div class="list-group-item">You are not a member of any groups yet.</div>';
            } else {
                groups.member.forEach(group => {
                    const item = document.createElement('div');
                    item.className = 'list-group-item d-flex justify-content-between align-items-center';
                    item.innerHTML = `
                        <div>
                            <h6>${group.name}</h6>
                            <small>${group.members} members</small>
                        </div>
                        <button class="btn btn-sm btn-outline-danger leave-group-btn" data-group-id="${group.id}">Leave</button>
                    `;
                    memberGroupsList.appendChild(item);
                });

                // Add event listeners to the leave buttons
                document.querySelectorAll('.leave-group-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const groupId = e.target.getAttribute('data-group-id');
                        leaveGroup(groupId);
                    });
                });
            }
        }

        // Create a new group
        async function createGroup(groupName) {
            const userData = JSON.parse(localStorage.getItem('discord_user'));
            if (!userData) return;
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/groups`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: groupName,
                        ownerId: userData.id
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to create group');
                }
                
                const result = await response.json();
                alert(result.message || `Group "${groupName}" created successfully!`);
                
                // Refresh the groups list
                fetchGroups(userData.id);
            } catch (error) {
                console.error('Error creating group:', error);
                // For demo purposes, simulate API response
                alert(`Group "${groupName}" created successfully!`);
                // Refresh the groups list
                fetchGroups(userData.id);
            }
        }

        // Prompt for user ID to invite
        function promptInvite(groupId) {
            const userId = prompt('Enter Discord User ID to invite:');
            if (userId) {
                sendInvite(groupId, userId);
            }
        }

        // Send an invite
        async function sendInvite(groupId, targetUserId) {
            const userData = JSON.parse(localStorage.getItem('discord_user'));
            if (!userData) return;
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/invites`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        groupId: groupId,
                        fromUserId: userData.id,
                        toUserId: targetUserId
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to send invite');
                }
                
                const result = await response.json();
                alert(result.message || `Invite sent to user ${targetUserId}!`);
            } catch (error) {
                console.error('Error sending invite:', error);
                // For demo purposes, simulate API response
                alert(`Invite sent to user ${targetUserId}!`);
            }
        }

        // Delete a group
        async function deleteGroup(groupId) {
            if (!confirm('Are you sure you want to delete this group?')) return;
            
            const userData = JSON.parse(localStorage.getItem('discord_user'));
            if (!userData) return;
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/groups/${groupId}?userId=${userData.id}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) {
                    throw new Error('Failed to delete group');
                }
                
                const result = await response.json();
                alert(result.message || 'Group deleted successfully!');
                
                // Refresh the groups list
                fetchGroups(userData.id);
            } catch (error) {
                console.error('Error deleting group:', error);
                // For demo purposes, simulate API response
                alert('Group deleted successfully!');
                // Refresh the groups list
                fetchGroups(userData.id);
            }
        }

        // Leave a group
        async function leaveGroup(groupId) {
            if (!confirm('Are you sure you want to leave this group?')) return;
            
            const userData = JSON.parse(localStorage.getItem('discord_user'));
            if (!userData) return;
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/groups/${groupId}/members/${userData.id}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) {
                    throw new Error('Failed to leave group');
                }
                
                const result = await response.json();
                alert(result.message || 'You left the group successfully!');
                
                // Refresh the groups list
                fetchGroups(userData.id);
            } catch (error) {
                console.error('Error leaving group:', error);
                // For demo purposes, simulate API response
                alert('You left the group successfully!');
                // Refresh the groups list
                fetchGroups(userData.id);
            }
        }

        // Fetch invites
        async function fetchInvites(userId) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/invites?userId=${userId}`);
                
                if (!response.ok) {
                    throw new Error('Failed to fetch invites');
                }
                
                const invites = await response.json();
                renderInvites(invites);
            } catch (error) {
                console.error('Error fetching invites:', error);
                // For demo purposes, fallback to mock data if the API call fails
                const mockInvites = [
                    { id: 'i1', groupId: 'g3', groupName: 'Shadow Hunters', fromUser: 'InviterUser#1234' }
                ];
                
                renderInvites(mockInvites);
            }
        }

        // Render invites
        function renderInvites(invites) {
            invitesList.innerHTML = '';
            if (invites.length === 0) {
                invitesList.innerHTML = '<div class="list-group-item">You don\'t have any pending invites.</div>';
            } else {
                invites.forEach(invite => {
                    const item = document.createElement('div');
                    item.className = 'list-group-item d-flex justify-content-between align-items-center';
                    item.innerHTML = `
                        <div>
                            <h6>${invite.groupName}</h6>
                            <small>Invited by ${invite.fromUser}</small>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-success accept-invite-btn" data-invite-id="${invite.id}">Accept</button>
                            <button class="btn btn-sm btn-danger decline-invite-btn" data-invite-id="${invite.id}">Decline</button>
                        </div>
                    `;
                    invitesList.appendChild(item);
                });

                // Add event listeners to the accept/decline buttons
                document.querySelectorAll('.accept-invite-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const inviteId = e.target.getAttribute('data-invite-id');
                        respondToInvite(inviteId, true);
                    });
                });

                document.querySelectorAll('.decline-invite-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const inviteId = e.target.getAttribute('data-invite-id');
                        respondToInvite(inviteId, false);
                    });
                });
            }
        }

        // Respond to an invite (accept/decline)
        async function respondToInvite(inviteId, accept) {
            const userData = JSON.parse(localStorage.getItem('discord_user'));
            if (!userData) return;
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/invites/${inviteId}/respond`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: userData.id,
                        accept: accept
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to respond to invite');
                }
                
                const result = await response.json();
                alert(result.message || (accept ? 'Invite accepted!' : 'Invite declined!'));
                
                // Refresh the invites list and groups
                fetchInvites(userData.id);
                fetchGroups(userData.id);
                fetchUserGroup(userData.id);
            } catch (error) {
                console.error('Error responding to invite:', error);
                // For demo purposes, simulate API response
                alert(accept ? 'Invite accepted!' : 'Invite declined!');
                // Refresh the invites list and groups
                fetchInvites(userData.id);
                fetchGroups(userData.id);
                fetchUserGroup(userData.id);
            }
        }
    </script>
</body>
</html>
